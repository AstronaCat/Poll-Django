{% extends 'sub-base.html' %}

{% block content %}
<div class="container mt-2">
    <h2 class="mb-4">보드 수정</h2>
    <div class="mb-3 row">
        <label for="id_name" class="col-form-label col-sm-3">보드 이름</label>
        <div class="col-sm-9">
            <input type="text" class="form-control" id="name" name="name" value="{{ board.name }}" placeholder="보드의 이름을 입력하세요" required>
        </div>
    </div>
    <div class="mb-3 row">
        <label for="start_time" class="col-sm-3 col-form-label">투표 시작 시각</label>
        <div class="col-sm-9">
            <input type="datetime-local" class="form-control" id="start_time" name="start_time"
                   value="{{ board.start_time|date:'Y-m-d H:i'}}">
        </div>
    </div>
    <div class="mb-3 row">
        <label for="end_time" class="col-sm-3 col-form-label">투표 종료 시각</label>
        <div class="col-sm-9">
            <input type="datetime-local" class="form-control" id="end_time" name="end_time"
                   value="{{ board.end_time|date:'Y-m-d H:i'}}">
        </div>
    </div>
    <div class="mb-3 row">
        <label class="col-sm-3 col-form-label">보드 활성화 여부</label>
        <div class="col-sm-9">
            <input type="checkbox" class="form-check-input" id="activate" name="activate"
                   {% if board.activate %}checked{% endif %}>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <button class="btn btn-primary me-2"><i class="bi bi-pencil"></i> 보드 정보 수정</button>
        <button class="btn btn-danger me-2"><i class="bi bi-trash"></i> 보드 삭제</button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createQuestionModal"><i class="bi bi-plus-lg"></i> 질문 만들기</button>
    </div>
</div>

<!-- 질문들 -->
<div class="container mt-2">
{% for question in questions %}
    <div class="card mb-2 shadow">
        <div class="card-body">
            <div class="card-title d-flex justify-content-between">
                <div class="fw-bolder">{{ question.text }}</div>
                <button class="btn btn-secondary btn-sm me-2"><i class="bi bi-pencil"></i> 질문 수정</button>
            </div>
            <div class="row">
                <div class="col-6 px-2">
                {% if question.media_type == 'image' %}
                    <img src="{{ question.media_url }}" alt="Image" class="img-thumbnail">
                {% elif question.media_type == 'video' %}
                    <iframe width="100%" height="360" src="https://www.youtube.com/embed/{{ question.video_id }}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                {% else %}
                    <p><미디어가 없습니다.></p>
                {% endif %}
                </div>
                <div class="col-6 px-2">
                    <ul>
                    {% for choice in question.choices %}
                        <li>{{ choice.text }} (Votes: {{ choice.votes }})</li>
                    {% empty %}
                        <li>이 질문에는 선택지가 없습니다.</li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% empty %}
이 보드에는 아직 질문이 없습니다. "질문 만들기" 버튼을 눌러 만드세요.
{% endfor %}
</div>

<!-- Question Modal -->
<div class="modal fade" id="createQuestionModal" tabindex="-1" aria-labelledby="createQuestionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createQuestionModalLabel">새 질문 만들기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createQuestionForm">
                    {% csrf_token %}
                    <!-- 질문 입력 -->
                    <div class="mb-3">
                        <label for="questionText" class="form-label">질문 내용</label>
                        <textarea class="form-control" id="questionText" rows="3" required></textarea>
                    </div>

                    <!-- 미디어 타입 선택 -->
                    <div class="mb-3">
                        <label for="mediaType" class="form-label">미디어 유형</label>
                        <select class="form-select" id="mediaType">
                            <option value="">선택하세요</option>
                            <option value="image">이미지</option>
                            <option value="video">비디오</option>
                        </select>
                    </div>

                    <!-- 미디어 URL -->
                    <div class="mb-3" id="mediaUrlContainer">
                        <label for="mediaUrl" class="form-label">미디어 URL</label>
                        <input type="url" class="form-control" id="mediaUrl" placeholder="미디어 URL을 입력하세요">
                    </div>

                    <div class="mb-3">
                        <label for="answer1" class="form-label">답변 보기</label>
                        <input type="text" class="form-control mb-1" id="answer1" placeholder="첫번째 보기를 입력하세요">
                        <input type="text" class="form-control mb-1" id="answer2" placeholder="두번째 보기를 입력하세요">
                        <input type="text" class="form-control mb-1" id="answer3" placeholder="세번째 보기를 입력하세요">
                        <input type="text" class="form-control mb-1" id="answer4" placeholder="네번째 보기를 입력하세요">
                        <input type="text" class="form-control mb-1" id="answer5" placeholder="다섯번째 보기를 입력하세요">
                        <input type="text" class="form-control" id="answer6" placeholder="여섯번째 보기를 입력하세요">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" id="createQuestionBtn" class="btn btn-primary">질문 만들기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // 폼 제출 시 AJAX 요청 보내기
        $('#createQuestionBtn').click(function (e) {
            e.preventDefault();  // 기본 폼 제출 동작 방지

            var questionText = $('#questionText').val();
            var mediaType = $('#mediaType').val();
            var mediaUrl = $('#mediaUrl').val();
            var answer1 = $('#answer1').val();
            var answer2 = $('#answer2').val();
            var answer3 = $('#answer3').val();
            var answer4 = $('#answer4').val();
            var answer5 = $('#answer5').val();
            var answer6 = $('#answer6').val();

            if (!questionText) {
                alert("질문을 입력해주세요.");
                return;
            }

            // REST API로 POST 요청 보내기
            $.ajax({
                url: '{% url 'api_create_question' %}',  // 여기에 실제 API URL을 입력합니다.
                type: 'POST',
                data: JSON.stringify({
                    'board_id': {{board.id}},
                    'text': questionText,
                    'media_type': mediaType,
                    'media_url': mediaUrl,
                    'answer1': answer1,
                    'answer2': answer2,
                    'answer3': answer3,
                    'answer4': answer4,
                    'answer5': answer5,
                    'answer6': answer6,
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // CSRF 토큰
                },
                success: function (response) {
                    // 요청이 성공하면 모달 닫고 폼 리셋
                    $('#createQuestionModal').modal('hide');
                    $('#createQuestionForm')[0].reset();
                    alert('질문이 성공적으로 생성되었습니다.');
                    window.location.reload(); // 페이지 새로고침
                },
                error: function (xhr, errmsg, err) {
                    alert('오류가 발생했습니다: ' + errmsg);
                }
            });
        });
    });
</script>

{% endblock %}