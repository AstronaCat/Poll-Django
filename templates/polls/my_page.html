{% extends 'base.html' %}
{% block content %}

<h3 class="text-center mt-2">마이 페이지</h3>

{% if user.is_authenticated %} <!-- 사용자 로그인이 감지된 경우-->
<div class="text-end pe-3">
    <button id="createBoard" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBoardModal">
        <i class="bi bi-plus-lg"></i> 보드 만들기
    </button>
</div>
{% else %} <!-- 사용자 로그인이 되어 있지 않은 상태 -->
<div>
    <p style="display: inline;">보드를 생성하려면 <a href="{% url 'login' %}">로그인</a>을 해야 합니다.</p>
</div>
{% endif %}

<br/>
<!-- 카드들 -->
<div class="container text-center">
    <div class="row row-cols-auto justify-content-center">
    {% for board in boards %}
        <div class="card col m-2 shadow">
            <div class="card-body d-flex flex-column">
                <div class="card-title fw-bolder">{{ board.name }}</div>
                <p class="card-text fs-6">Created by: {{ board.created_by.username }}</p>
                <div class="mb-2">
                {% if board.questions|length > 0 %}
                    <div>질문 {{ board.question_count }} 개</div>
                    {% if board.questions.0.media_type == 'image' %}
                        <img src="{{ board.questions.0.media_url }}" alt="Image" class="img-thumbnail" style="max-width: 10rem">
                    {% elif board.questions.0.media_type == 'video' %}
                        <img src="https://img.youtube.com/vi/{{ board.questions.0.video_id }}/maxresdefault.jpg" alt="Image" class="img-thumbnail" style="max-width: 10rem">
                    {% else %}
                        미디어 없음
                    {% endif %}
                {% else %}
                    <div>질문 없음</div>
                {% endif %}
                </div>
                <a href="{% url 'board_modify' board.id %}" class="btn btn-secondary btn-sm mt-auto">수정하기</a>
            </div>
        </div>
    {% endfor %}
    </div>
</div>


<!-- 모달 다이얼로그 -->
<div class="modal fade" id="createBoardModal" tabindex="-1" aria-labelledby="createBoardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createBoardModalLabel">보드 만들기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 여기에 내용을 넣으세요 -->
                <form id="createBoardForm">
                    <div class="mb-3">
                        <label for="boardName" class="form-label">보드 이름</label>
                        <input type="text" class="form-control" id="boardName" name="boardName" required>
                    </div>
                    <!-- Start Time -->
                    <div class="mb-3">
                        <label for="startTime" class="form-label">시작 시간</label>
                        <input
                            type="datetime-local"
                            class="form-control"
                            id="startTime"
                            name="start_time">
                    </div>
                    <!-- End Time -->
                    <div class="mb-3">
                        <label for="endTime" class="form-label">종료 시간</label>
                        <input
                            type="datetime-local"
                            class="form-control"
                            id="endTime"
                            name="end_time">
                    </div>
                    <!-- Activate -->
                    <div class="form-check mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="activate"
                            name="activate">
                        <label for="activate" class="form-check-label">활성화</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" id="createBoardBtn" class="btn btn-primary">만들기</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    $("#createBoardBtn").on("click", function (e) {
        e.preventDefault();

        // Form data
        const boardName = $("#boardName").val().trim();
        const startTime = $("#startTime").val();  // 2024-12-12T23:53 의 형식임.
        const endTime = $("#endTime").val();
        const activate = $("#activate").is(":checked");

        if (!boardName) {
            alert("보드 이름을 입력해주세요.");
            return;
        }

        // AJAX 요청
        $.ajax({
            url: "{% url 'api_create_board' %}", // 서버의 URL
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                name: boardName,
                start_time: startTime,
                end_time: endTime,
                activate: activate,
            }),
            headers: {
                "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val(),
            },
            success: function (response) {
                alert(response.message || "보드가 성공적으로 생성되었습니다!");
                $("#createBoardModal").modal("hide"); // 모달 닫기
                window.location.reload(); // 페이지 새로고침
            },
            error: function (xhr, status, error) {
                alert("보드 생성 중 오류가 발생했습니다.");
                console.error("Error:", error);
            },
        });
    });
});

</script>
{% endblock %}