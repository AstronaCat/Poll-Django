{% extends 'sub-base.html' %}

{% block content %}
<div class="container mt-2">
    <h2 class="mb-4 text-center">투표하기</h2>
    <div class="mb-3 row">
        <label for="name" class="col-form-label col-sm-3">보드 이름</label>
        <div class="col-sm-9">
            <input type="text" class="form-control" id="name" name="name" value="{{ board.name }}" placeholder="보드의 이름을 입력하세요" disabled>
        </div>
    </div>
    <div class="mb-3 row">
        <label for="start_time" class="col-sm-3 col-form-label">투표 시작 시각</label>
        <div class="col-sm-9">
            <input type="datetime-local" class="form-control" id="start_time" name="start_time"
                   value="{{ board.start_time|date:'Y-m-d H:i'}}" disabled>
        </div>
    </div>
    <div class="mb-3 row">
        <label for="end_time" class="col-sm-3 col-form-label">투표 종료 시각</label>
        <div class="col-sm-9">
            <input type="datetime-local" class="form-control" id="end_time" name="end_time"
                   value="{{ board.end_time|date:'Y-m-d H:i'}}" disabled>
        </div>
    </div>
</div>

<!-- 질문들 -->
<div class="container mt-2">
{% for question in questions %}
    <div class="card mb-2 shadow">
        <div class="card-body">
            <div class="card-title d-flex justify-content-between">
                <div class="fw-bolder">{{ question.text }}</div>
            </div>
            <div class="row">
                <div class="col-6 px-2">
                {% if question.media_type == 'image' %}
                    <img src="{{ question.media_url }}" alt="Image" class="img-thumbnail">
                {% elif question.media_type == 'video' %}
                    <iframe width="100%" height="360" src="https://www.youtube.com/embed/{{ question.video_id }}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                {% else %}
                    <p>-- 미디어가 없습니다 --</p>
                {% endif %}
                </div>
                <div class="col-6 px-2">
                    {% for choice in question.choices %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   name="choice-{{ question.id }}"
                                   id="choice-{{ choice.id }}"
                                   value="{{ choice.id }}">
                            <label class="form-check-label" for="choice-{{ choice.id }}">
                                {{ choice.text }}
                            </label>
                        </div>
                    {% empty %}
                        <li>이 질문에는 선택지가 없습니다.</li>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% empty %}
이 보드에는 아직 질문이 없습니다. "질문 만들기" 버튼을 눌러 만드세요.
{% endfor %}
</div>

<div class="text-center my-4">
    <button type="button" class="btn btn-primary" id="voteBtn">
        <i class="bi bi-send"></i>
        투표하기
    </button>
</div>


<script>
$(document).ready(function () {
    $("#modifyBoardBtn").on("click", function (e) {
        e.preventDefault();

        // Form data
        const boardName = $("#name").val().trim();
        const startTime = $("#start_time").val();  // 2024-12-12T23:53 의 형식임.
        const endTime = $("#end_time").val();
        const activate = $("#activate").is(":checked");
        const completed = $("#completed").is(":checked");

        if (!boardName) {
            alert("보드 이름을 입력해주세요.");
            return;
        }

        // AJAX 요청
        $.ajax({
            url: "{% url 'api_modify_board' %}", // 서버의 URL
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                board_id: {{board.id}},
                name: boardName,
                start_time: startTime,
                end_time: endTime,
                activate: activate,
                completed: completed
            }),
            headers: {
                "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val(),
            },
            success: function (response) {
                alert(response.message || "보드가 성공적으로 수정되었습니다!");
                $("#createBoardModal").modal("hide"); // 모달 닫기
                window.location.reload(); // 페이지 새로고침
            },
            error: function (xhr, status, error) {
                alert("보드 생성 중 오류가 발생했습니다.");
                console.error("Error:", error);
            },
        });
    });
});


    $(document).ready(function () {
        // 폼 제출 시 AJAX 요청 보내기
        $('#createQuestionBtn').click(function (e) {
            e.preventDefault();  // 기본 폼 제출 동작 방지

            var questionText = $('#questionText').val();
            var mediaType = $('#mediaType').val();
            var mediaUrl = $('#mediaUrl').val();
            var answer1 = $('#answer1').val();
            var answer2 = $('#answer2').val();
            var answer3 = $('#answer3').val();
            var answer4 = $('#answer4').val();
            var answer5 = $('#answer5').val();
            var answer6 = $('#answer6').val();

            if (!questionText) {
                alert("질문을 입력해주세요.");
                return;
            }

            // REST API로 POST 요청 보내기
            $.ajax({
                url: '{% url 'api_create_question' %}',  // 여기에 실제 API URL을 입력합니다.
                type: 'POST',
                data: JSON.stringify({
                    'board_id': {{board.id}},
                    'text': questionText,
                    'media_type': mediaType,
                    'media_url': mediaUrl,
                    'answer1': answer1,
                    'answer2': answer2,
                    'answer3': answer3,
                    'answer4': answer4,
                    'answer5': answer5,
                    'answer6': answer6,
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // CSRF 토큰
                },
                success: function (response) {
                    // 요청이 성공하면 모달 닫고 폼 리셋
                    $('#createQuestionModal').modal('hide');
                    $('#createQuestionForm')[0].reset();
                    alert('질문이 성공적으로 생성되었습니다.');
                    window.location.reload(); // 페이지 새로고침
                },
                error: function (xhr, errmsg, err) {
                    alert('오류가 발생했습니다: ' + errmsg);
                }
            });
        });
    });
</script>

{% endblock %}